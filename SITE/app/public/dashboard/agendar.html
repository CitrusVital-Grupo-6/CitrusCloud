<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CitrusVital | Agendar Pulverização</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
        integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="../../css/agendar.css">
    <link rel="stylesheet" href="../../css/calendar.css">
    <link rel="stylesheet" href="../../css/dashboard.css">
    <link rel="stylesheet" href="../../css/defen-item.css">
    <link rel="shortcut icon" href="../assets/icon/logo.ico" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-trendline"></script>
</head>

<body>
    <aside id="aside-menu">
    </aside>

    <main class="main-agendar">
        <div class="title">
            <div>
                <h1 class="main-title">AGENDAR PULVERIZAÇÃO</h1>
                <h3 class="subtitle" id="subtitle">Carregando...</h3>
            </div>
            <div class="buttons">
                <button class="main-button" onclick="cancelarPulv()">Cancelar</button>
                <button class="main-button disabled" id="confirmar" onclick="agendarPulverizacao()">Confirmar</button>
            </div>
        </div>
        <div class="main-content-wrapper">
            <div class="left-content">
                <div class="kpi-container">
                    <div class="kpi-box">
                        <div class="kpi-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="42" height="42" fill="#636363"
                                viewBox="0 0 256 256">
                                <path
                                    d="M212,58a26,26,0,1,0,26,26A26,26,0,0,0,212,58Zm0,40a14,14,0,1,1,14-14A14,14,0,0,1,212,98Zm-86,56.6V88a6,6,0,0,0-12,0v66.6a30,30,0,1,0,12,0ZM120,202a18,18,0,1,1,18-18A18,18,0,0,1,120,202Zm38-67V48a38,38,0,0,0-76,0v87a62,62,0,1,0,76,0Zm-38,99a50,50,0,0,1-28.57-91A6,6,0,0,0,94,138V48a26,26,0,0,1,52,0v90a6,6,0,0,0,2.57,4.92A50,50,0,0,1,120,234Z">
                                </path>
                            </svg>
                        </div>
                        <kpi class="kpi-text">
                            <h1>Temperatura</h1>
                            <span id="temperatura">Carregando...</span>
                        </kpi>
                    </div>
                    <div class="kpi-box">
                        <div class="kpi-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="42" height="42" fill="#636363"
                                viewBox="0 0 256 256">
                                <path
                                    d="M172.53,49.06a252.86,252.86,0,0,0-41.09-38,6,6,0,0,0-6.88,0,252.86,252.86,0,0,0-41.09,38C56.34,80.26,42,113.09,42,144a86,86,0,0,0,172,0C214,113.09,199.66,80.26,172.53,49.06ZM128,218a74.09,74.09,0,0,1-74-74c0-59.62,59-108.93,74-120.51C143,35.07,202,84.38,202,144A74.09,74.09,0,0,1,128,218Zm53.92-65A55.58,55.58,0,0,1,137,197.92a7,7,0,0,1-1,.08,6,6,0,0,1-1-11.92c17.38-2.92,32.13-17.68,35.08-35.08a6,6,0,1,1,11.84,2Z">
                                </path>
                            </svg>
                        </div>
                        <kpi class="kpi-text">
                            <h1>Umidade</h1>
                            <span id="umidade">Carregando...</span>
                        </kpi>
                    </div>
                    <div class="kpi-box">
                        <div class="kpi-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="42" height="42" fill="#636363"
                                viewBox="0 0 256 256">
                                <path
                                    d="M157,195.33l-32,48a6,6,0,1,1-10-6.66l32-48a6,6,0,0,1,10,6.66ZM230,92a74.09,74.09,0,0,1-74,74H131.21L101,211.33a6,6,0,1,1-10-6.66L116.79,166H76A50,50,0,1,1,86.2,67,74.08,74.08,0,0,1,230,92Zm-12,0A62.06,62.06,0,0,0,94,88.35a6,6,0,0,1-12-.7,75.84,75.84,0,0,1,1.07-9A38,38,0,1,0,76,154h80A62.07,62.07,0,0,0,218,92Z">
                                </path>
                            </svg>
                        </div>
                        <kpi class="kpi-text">
                            <h1>Chance de Chuva</h1>
                            <span id="chanceChuva">Carregando...</span>
                        </kpi>
                    </div>
                </div>
                <div class="calendar-container">
                    <h1>dias recomendados</h1>
                    <div class="calendar">
                        <div>
                            <div class="month">
                                <i class="fas fa-angle-left prev"></i>
                                <div class="date">december 2024</div>
                                <i class="fas fa-angle-right next"></i>
                            </div>
                            <div class="weekdays">
                                <div>dom</div>
                                <div>seg</div>
                                <div>ter</div>
                                <div>qua</div>
                                <div>qui</div>
                                <div>sex</div>
                                <div>sab</div>
                            </div>
                            <div class="days"></div>
                        </div>
                    </div>
                </div>
            </div>


            <div class="right-content">
                <div class="defen-item-wrapper">
                    <h1>DEFENSIVOS RECOMENDADOS</h1>
                    <div class="defen-item-container" id="box_agrotoxico">
                        <label class="defen-item">
                            <div class="defen-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="42" height="42" fill="#636363"
                                    viewBox="0 0 256 256">
                                    <path
                                        d="M236.24,87.76l-60-60a6,6,0,0,0-8.48,0L38.53,157A42.77,42.77,0,1,0,99,217.47L211.24,105.24l22.66-7.55a6,6,0,0,0,2.34-9.93ZM90.53,209A30.77,30.77,0,1,1,47,165.47l29.13-29.12c8.84-3.14,22.84-4.56,41.08,5,12.28,6.41,23.13,8.66,32.27,8.71ZM206.1,94.31a6,6,0,0,0-2.34,1.45l-39.9,39.89c-8.84,3.14-22.84,4.56-41.08-5C110.5,124.27,99.65,122,90.51,122L172,40.49l48.89,48.89Z">
                                    </path>
                                </svg>
                            </div>
                            <div class="defen-info">
                                <span>Carregando...</span>
                            </div>
                        </label>
                    </div>
                </div>
                <div class="graph-box">
                    <h1>eficiência dos defensivos em relação ao dia</h1>
                    <div>
                        <canvas id="graficoEfic"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        function addListner() {
            const days = document.querySelectorAll(".day");
            days.forEach((day) => {
                day.addEventListener("click", (e) => {
                getActiveDay(e.target.innerHTML); // Define o dia ativo
                activeDay = Number(e.target.innerHTML);
                // Remove a classe "active" de todos os dias
                days.forEach((day) => {
                    day.classList.remove("active");
                });
                // Verifica se o clique foi em um dia do mês anterior ou próximo
                if (e.target.classList.contains("prev-date")) {
                    prevMonth();
                    setTimeout(() => {
                    const days = document.querySelectorAll(".day");
                    days.forEach((day) => {
                        if (
                        !day.classList.contains("prev-date") &&
                        day.innerHTML === e.target.innerHTML
                        ) {
                        day.classList.add("active");
                        }
                    });
                    }, 100);
                } else if (e.target.classList.contains("next-date")) {
                    nextMonth();
                    setTimeout(() => {
                    const days = document.querySelectorAll(".day");
                    days.forEach((day) => {
                        if (
                        !day.classList.contains("next-date") &&
                        day.innerHTML === e.target.innerHTML
                        ) {
                        day.classList.add("active");
                        }
                    });
                    }, 100);
                } else {
                    e.target.classList.add("active"); // Adiciona a classe "active" ao dia selecionado
                    updateEvents(activeDay)
                    box_agrotoxico.innerHTML = ""
                    recomendarAgrotoxico();
                }
                });
            });
            }
    
    </script>

    <script src="../../middlewares/aside-menu.js"></script>
    <script src="../../middlewares/graficoEfic.js"></script>
    <script src="../../middlewares/calendar.js"></script>
</body>

</html>

<script>
    const OPENWEATHER_API_KEY = 'f4652d12e1e313414bdf86ce7dff0d93';
  
    const parsedFazendaData = JSON.parse(sessionStorage.getItem("FAZENDA_DATA"));
    const parsedAgendarData = JSON.parse(sessionStorage.getItem("TALHAO_AGENDAR"));

    const pragaTalhao = parsedAgendarData.idPraga;
    const idTalhao = parsedAgendarData.idTalhao;
    const cepTalhao = parsedFazendaData.cep;

    let temperaturaAtual;
    let umidadeAtual;
    let popAtual;
    let diaAtual;
    let idAgrotoxico;

    async function buscarPrevisaoTempo(cep) {
        console.log(cep)
        const cepLimpo = cep.replace(/\D/g, '');
        console.log(cepLimpo);

        try {
            const responseViaCEP = await fetch(`https://viacep.com.br/ws/${cepLimpo}/json/`);
            const dataViaCEP = await responseViaCEP.json();
            if (dataViaCEP.erro) {
                alert('CEP não encontrado.');
                return;
            }

            const enderecoCompleto = `${dataViaCEP.logradouro}, ${dataViaCEP.bairro}, ${dataViaCEP.localidade}`;

            const responseGeocoding = await fetch(`https://nominatim.openstreetmap.org/search?q=${enderecoCompleto}&format=json&addressdetails=1&limit=1`);
            const dataGeocoding = await responseGeocoding.json();

            let latitude, longitude;

            if (dataGeocoding && dataGeocoding.length > 0) {
                latitude = dataGeocoding[0].lat;
                longitude = dataGeocoding[0].lon;
            } else {
                alert('Não foi possível obter as coordenadas geográficas do CEP.');
                return;
            }


            const responseOpenWeather = await fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${latitude}&lon=${longitude}&appid=${OPENWEATHER_API_KEY}&units=metric&lang=pt_br`);
            const dataOpenWeather = await responseOpenWeather.json();

            const previsaoPorDia = {};

            dataOpenWeather.list.forEach(item => {
                const data = new Date(item.dt * 1000);
                const dia = data.toLocaleDateString();

                if (!previsaoPorDia[dia]) {
                    previsaoPorDia[dia] = {
                        temperatura_maxima: -Infinity,
                        temperatura_minima: Infinity,
                        umidade: [],
                        probabilidade_chuva: 0,
                        descricao: ''
                    };
                }

                previsaoPorDia[dia].temperatura_maxima = Math.max(previsaoPorDia[dia].temperatura_maxima, item.main.temp_max);
                previsaoPorDia[dia].temperatura_minima = Math.min(previsaoPorDia[dia].temperatura_minima, item.main.temp_min);
                previsaoPorDia[dia].umidade.push(item.main.humidity);
                previsaoPorDia[dia].probabilidade_chuva = Math.max(previsaoPorDia[dia].probabilidade_chuva, item.pop);
                previsaoPorDia[dia].descricao = item.weather[0].description;
            });

            console.log(previsaoPorDia)

            const primeiroDia = Object.keys(previsaoPorDia)[0];
            const previsao = previsaoPorDia[primeiroDia];

            // Calcula a média de umidade
            const mediaUmidade = previsao.umidade.reduce((acc, val) => acc + val, 0) / previsao.umidade.length;

            document.getElementById('temperatura').textContent = `${previsao.temperatura_maxima.toFixed(0)}°C`;
            document.getElementById('umidade').textContent = `${mediaUmidade.toFixed(0)}%`; // Exibe a média
            document.getElementById('chanceChuva').textContent = `${(previsao.probabilidade_chuva * 100).toFixed(0)}%`;

            temperaturaAtual = previsao.temperatura_maxima.toFixed(0);
            umidadeAtual = mediaUmidade.toFixed(0);
            popAtual = (previsao.probabilidade_chuva * 100).toFixed(0);

            diasRecomendadosAgendar(previsaoPorDia);
            markEventDays();
            console.log(eventsArr)
        } catch (error) {
            console.error('Erro ao buscar previsão do tempo:', error);
            alert('Ocorreu um erro ao buscar a previsão do tempo.');
        }
    }

    async function recomendarAgrotoxico(){
        console.log(temperaturaAtual)
        
        if(popAtual <= 30){
            let tempoCura = 6;
        } else {
            tempoCura = 24;
        }

        const params = {
            idPragaServer: pragaTalhao,
            tempServer: temperaturaAtual
        }

        fetch('/pulverizacao/listarDefensivosPorPraga', {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(params)
        })
            .then(response  => {
                if (response.status === 204 || popAtual > 30) {
                    box_agrotoxico.innerHTML = `
                            <label class="defen-item">
                                <div class="defen-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="42" height="42" fill="#636363"
                                        viewBox="0 0 256 256">
                                        <path
                                            d="M236.24,87.76l-60-60a6,6,0,0,0-8.48,0L38.53,157A42.77,42.77,0,1,0,99,217.47L211.24,105.24l22.66-7.55a6,6,0,0,0,2.34-9.93ZM90.53,209A30.77,30.77,0,1,1,47,165.47l29.13-29.12c8.84-3.14,22.84-4.56,41.08,5,12.28,6.41,23.13,8.66,32.27,8.71ZM206.1,94.31a6,6,0,0,0-2.34,1.45l-39.9,39.89c-8.84,3.14-22.84,4.56-41.08-5C110.5,124.27,99.65,122,90.51,122L172,40.49l48.89,48.89Z">
                                        </path>
                                    </svg>
                                </div>
                                <div class="defen-info">
                                    <span>Nenhum defensivo recomendado</span>
                                </div>
                            </label>`;
                    return;
                }

                response.json().then(data => {
                    box_agrotoxico.innerHTML = '';
                    for (let posicao = 0; posicao < data.length; posicao++) {
                        box_agrotoxico.innerHTML += `
                            <label class="defen-item">
                                <div class="defen-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="42" height="42" fill="#636363"
                                        viewBox="0 0 256 256">
                                        <path
                                            d="M236.24,87.76l-60-60a6,6,0,0,0-8.48,0L38.53,157A42.77,42.77,0,1,0,99,217.47L211.24,105.24l22.66-7.55a6,6,0,0,0,2.34-9.93ZM90.53,209A30.77,30.77,0,1,1,47,165.47l29.13-29.12c8.84-3.14,22.84-4.56,41.08,5,12.28,6.41,23.13,8.66,32.27,8.71ZM206.1,94.31a6,6,0,0,0-2.34,1.45l-39.9,39.89c-8.84,3.14-22.84,4.56-41.08-5C110.5,124.27,99.65,122,90.51,122L172,40.49l48.89,48.89Z">
                                        </path>
                                    </svg>
                                </div>
                                <div class="defen-info">
                                    <h3>${data[posicao].nomeAgrotoxico}</h3>
                                    <div style="display: flex; gap: 15px;">
                                        <span><b>Temperatura:</b> ${data[posicao].minTemperatura}ºC - ${data[posicao].maxTemperatura}ºC</span>
                                        <span><b>Tempo de Cura:</b> ${data[posicao].minSemChuva} horas</span>
                                    </div>
                                </div>
                                <input type="checkbox" name="defen-group" data-id="${data[posicao].idAgrotoxico}">
                            </label>`;
                    }

                    const checkboxes = document.querySelectorAll('input[name="defen-group"]');
                    checkboxes.forEach(checkbox => {
                        checkbox.addEventListener('change', () => {
                            if (checkbox.checked) {
                                checkboxes.forEach(box => {
                                    if (box !== checkbox) box.checked = false;
                                });
                            }

                            verificarBtnPulverizar()
                        });
                    });
                })
            }
        )
    }

    async function buscarCEP(cep) {
        const cepUrl = cep.replace(/\D/g, '');
        const url = `https://viacep.com.br/ws/${cepUrl}/json/`;

        try {
            const response = await fetch(url);
            const data = await response.json();

            if (data.erro) {
                alert('CEP não encontrado.');
                return;
            }

            subtitle.innerHTML = `${data.localidade}, ${data.estado} | <b>PRAGA:</b> ${parsedAgendarData.praga}`;
        } catch (error) {
            console.error('Erro ao buscar CEP:', error);
            alert('Ocorreu um erro ao buscar o CEP. Verifique a sua conexão com a internet.');
        }
    }

    function cancelarPulv() {
        sessionStorage.removeItem('TALHAO_AGENDAR')
        window.location.href= './talhao.html';
    }

    window.onload = async () => {
        try {
            await buscarCEP(cepTalhao);
            await buscarPrevisaoTempo(cepTalhao);
            recomendarAgrotoxico()
        } catch (error) {
            console.error('Deu erro aí')
        }
    };

    function verificarBtnPulverizar() {
    console.log('bumbum');
    const checkboxSelecionado = document.querySelector('input[name="defen-group"]:checked');

    if (checkboxSelecionado) {
        idAgrotoxico = checkboxSelecionado.dataset.id;
        confirmar.classList.remove("disabled");
    } else {
        confirmar.classList.add("disabled");
    }

    console.log('fkAgrotoxico:', idAgrotoxico); // Log do valor selecionado
}
    
    function agendarPulverizacao() {
        fetch("/pulverizacao/adicionarPulverizacao", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                fkTalhaoServer: idTalhao,
                fkAgrotoxicoServer: idAgrotoxico,
                dataPulverizacaoServer: diaAtual
            })
        })
            .then(response => {
                console.log("Status da resposta:", response.status);
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                return response.json();
            })
            .then(resultado => {
                console.log("Pulverização agendada com sucesso:", resultado);
                sessionStorage.removeItem('TALHAO_AGENDAR');
                sessionStorage.removeItem('FAZENDA_DATA');

                window.location.href='./fazendas.html'
            })
            .catch(error => {
                console.error("Erro ao agendar pulverização:", error);
                alert("Erro ao agendar pulverização: " + error.message);
            });
    }

    function cadastrar() {
        fetch("/usuarios/cadastrar", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                nomeEmpresaServer: nomeEmpresaVar,
                cnpjEmpresaServer: cnpjEmpresaVar,
                telefoneEmpresaServer: telefoneEmpresaVar,
                nomeFuncServer: nomeFuncVar,
                funcaoFuncServer: funcaoFuncVar,
                cpfFuncServer: cpfFuncVar,
                emailFuncServer: emailFuncVar,
                senhaFuncServer: senhaFuncVar
            }),
        })
        .then(function (resposta) {
            console.log("resposta: ", resposta);

            if (resposta.ok) {
                console.log("Cadastro realizado com sucesso! Redirecionando para tela de Login...");

                setTimeout(() => {
                    window.location = "./login.html";
                }, "2000");
            } else {
                throw "Houve um erro ao tentar realizar o cadastro!";
            }
        })
        .catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });
    }
</script>