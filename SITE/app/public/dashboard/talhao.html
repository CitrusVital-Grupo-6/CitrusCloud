<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../css/dashboard.css">

    <link href='https://fonts.googleapis.com/css?family=Inter' rel='stylesheet'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
        integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <title>CitrusVital | Talhões</title>
</head>

<body id="fazendas" onload="bumBum()">
    <aside id="aside-menu">
    </aside>

    <main id="main-content">
        <div class="title">
            <h1 class="main-title" id="nome-fazenda">Fazenda Citrus</h1>
            <div class="buttons">
                <button class="main-button" onclick="modal_talhao.showModal()">Adicionar</button>

                <dialog id="modal_talhao">
                    <div class="container-modal-talhao">
                        <div class="box-titulo-talhao">
                            <span class="titulo-modal-talhao">ADICIONAR TALHÃO</span>
                            <button class="botao-fechar-modal-talhao" onclick="modal_talhao.close()"><img width="24"
                                    height="24" src="https://img.icons8.com/material-outlined/24/delete-sign.png"
                                    alt="delete-sign" /></button>
                        </div>
                        <div class="box-talhao">
                            <div class="box-childrem-talhao">
                                <span>NOME</span>
                                <input class="input-hectar" type="text" name="" id="input_nome_talhao">
                            </div>
                            <div class="box-childrem-talhao">
                                <span>HECTARES</span>
                                <input class="input-hectar" type="text" name="" id="input_qtd_hactar">
                            </div>
                            <div class="box-childrem-talhao">
                                <span>TIPO DE LARANJA</span>
                                <select class="input-hectar" id="tipo_laranja">
                                    <option value="laranja_bahia">Laranja Bahia</option>
                                    <option value="larana_pera">Laranja Pêra</option>
                                    <option value="laranja_natal">Laranja Natal</option>
                                    <option value="laranja_da_terra">Laranja-da-terra</option>
                                    <option value="laranja_hamlin">Laranja Hamlin</option>
                                    <option value="laranja_lima">Laranja Lima</option>
                                </select>
                            </div>
                        </div>
                        <button onclick="adicionarTalhao()" class="botao-adicionar-talhao">ADICIONAR</button>
                    </div>
                </dialog>

                <dialog id="modal_pulverizacao">
                    <div class="container-modal-pulverizacao">
                        <div class="box-titulo-pulverizacao">
                            <span class="titulo-modal-pulverizacao">
                                AGENDAR PULVERIZAÇÃO
                            </span>
                            <button class="botao-fechar-modal-pulverizacao" onclick="modal_pulverizacao.close()"><img
                                    width="24" height="24"
                                    src="https://img.icons8.com/material-outlined/24/delete-sign.png"
                                    alt="delete-sign" /></button>
                        </div>
                        <div id="pragas" class="container-pragas">
                            <div class="box-pragas">
                                <div class="pragas">
                                    <span>PRAGA 1</span>
                                    <select name="" id="escolher-praga">
                                        <option value="">Ferrugem</option>
                                    </select>
                                </div>
                                <div class="hectares">
                                    <span>HECTARES</span>
                                    <input id="input_hectares_afetado" placeholder="Hectares afetados pela praga"
                                        type="text" name="">
                                </div>
                            </div>
                        </div>
                        <div class="box-adicionar-praga">
                            <button class="adicionar-praga" onclick="adicionarPraga()">+</button>
                        </div>
                        <div class="data-desejada">
                            DATA DESEJADA
                            <input class="data-inicio" type="date">
                        </div>
                        <button onclick="recomendacoes()" class="botao-recomendacoes">Recomendações</button>
                    </div>
                </dialog>

            </div>
        </div>

        <div id="card" class="cards-group"></div>

    </main>

    <script src="../../middlewares/aside-menu.js"></script>
    <script>  
        function buscarTalhoes(idFazenda) {
            fetch(`/talhao/exibirTalhao?idFazenda=${idFazenda}`)
                .then(res => res.json())
                .then(talhoes => {
                    const card = document.getElementById('card'); 
                    card.innerHTML = '';
    
                    for (let posicao = 0; posicao < talhoes.length; posicao++) {
                        card.innerHTML += ` 
                            <div onclick="modal_pulverizacao.showModal()" class="card">
                                <img src="../../assets/img/plot.jpg" alt="Fazenda" class="card-image">
                                <div class="card-content">
                                    <h3 class="card-subtitle">${talhoes[posicao].tipoLaranja}</h3>
                                    <h2 class="card-title">${talhoes[posicao].nome}</h2>
                                </div>
                            </div>`;
                    }
                })
                .catch(error => {
                    console.error('Erro ao buscar talhões:', error);
                });
        }
    
        function bumBum() {
            const fazendaData = JSON.parse(sessionStorage.getItem("FAZENDA_DATA"));
            console.log(fazendaData);
            document.getElementById("nome-fazenda").innerHTML = fazendaData.name;
    
            if (fazendaData) {
                buscarTalhoes(fazendaData.idFazenda);
            }
        }
    
        document.addEventListener("DOMContentLoaded", function () {
            const fazendaData = JSON.parse(sessionStorage.getItem("TALHAO_DATA"));
    
            if (fazendaData) {
                buscarTalhoes(fazendaData.idFazenda);
            }
        });
    
        function adicionarTalhao() {
            const fazendaData = JSON.parse(sessionStorage.getItem("TALHAO_DATA"));
            const nomeTalhao = document.getElementById('input_nome_talhao').value;
            const tamanhoHectar = document.getElementById('input_qtd_hactar').value;
            const tipoLaranja = document.getElementById('tipo_laranja').value;
    
            fetch("/talhao/adicionarTalhao", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    nomeTalhao: nomeTalhao,
                    tamanhoHectar: tamanhoHectar,
                    tipoLaranja: tipoLaranja,
                    idFazenda: fazendaData.idFazenda
                }),
            })
                .then(response => {
                    if (response.ok) {
                        modal_talhao.close();
                        buscarTalhoes(fazendaData.idFazenda); 
                    } else {
                        throw new Error("Erro ao adicionar talhão.");
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                });
        }
    
        function adicionarPraga() {
            let idInnerPragas = document.getElementById("pragas");
    
            idInnerPragas.innerHTML += `<div class="box-pragas">
            <div class="pragas">
                <span>PRAGA 1</span>
                <select name="" id="escolher-praga">
                    <option value="">Ferrugem</option>
                </select>
            </div>
            <div class="hectares">
                <span>HECTARES</span>
                <input placeholder="Hectares afetados pela praga" type="text" name="" id="input_hectares_afetado">
            </div>
        </div>`;
        }
    
        function recomendacoes() {
            modal_pulverizacao.close();
        }
    </script>
</body>
</html>

<script>
    let selectPraga = document.getElementById('escolher-praga'); // Selecione o elemento select da praga
    let selectDefensivo = document.createElement('select'); // Crie o select para os defensivos


    selectPraga.addEventListener('change', function() {  // Adicione um event listener
        let idPraga = this.value;
        if (idPraga) {
            obterDefensivos(idPraga);
        } else {
            selectDefensivo.innerHTML = ''; // Limpa as opções se nenhuma praga for selecionada.
        }
    });

    function obterDefensivos(idPraga) {
        fetch(`usuarios/listarDefensivosPorPraga/${idPraga}`)
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else if (response.status == 204) {
                    alert("Nenhum defensivo encontrado para esta praga.")
                     selectDefensivo.innerHTML = ''; // Limpa as opções se nenhuma praga for encontrada.

                    throw new Error("Nenhum defensivo encontrado para esta praga."); // Rejeita a promise para o catch
                    

                } else {
                    throw new Error("Erro ao obter defensivos.");
                }
            })
            .then(defensivos => {
                selectDefensivo.innerHTML = ''; // Limpa as opções anteriores
                defensivos.forEach(defensivo => {
                    let option = document.createElement('option');
                    option.value = defensivo.idAgrotoxico; // Define o valor como o ID do defensivo.
                    option.text = defensivo.nome; // Define o texto visível como o nome do defensivo.
                    selectDefensivo.appendChild(option);
                });

                // Adicione o select de defensivos ao HTML (substitua 'seu-elemento' pelo ID do elemento onde você quer adicionar o select)
                let containerDefensivo = document.getElementById('pragas') // Exemplo
                containerDefensivo.appendChild(selectDefensivo);


            })
            .catch(error => {
                console.error("Erro na requisição:", error);
                alert("Erro ao obter defensivos: " + error.message); // Exibe a mensagem de erro para o usuário

            });
    }


    function agendarPulverizacao() {
        let fkTalhao = // Precisa passar o fk do talhão como SESSION, boa sorte irmão //
        let fkAgrotoxico = selectDefensivo.value;
        let dataPulverizacao = document.querySelector('.data-inicio').value;

        let dados = {
            fkTalhaoServer: fkTalhao,
            fkAgrotoxicoServer: fkAgrotoxico,
            dataPulverizacaoServer: dataPulverizacao
        };


        fetch("usuarios/adicionarPulverizacao", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(dados)
        })
            .then(response => response.json())
            .then(resultado => {

                console.log("Pulverização agendada com sucesso:", resultado);

                modal_pulverizacao.close();
            })
            .catch(error => {
                console.error("Erro ao agendar pulverização:", error);
                alert("Erro ao agendar pulverização: " + error.message)
            });
    }
</script>