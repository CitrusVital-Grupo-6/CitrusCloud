<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Testes</title>

    <link rel="stylesheet" href="../../css/dashboard.css">
    <link rel="stylesheet" href="../../css/colunaSample.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
    <aside id="aside-menu">
    </aside>
    
    <main class="login-container">
        <div class="title">
            <div>
                <h1 class="main-title">usuários</h1>
            </div>
            <div>
                <button class="main-button" onclick="user_register_modal.showModal()">Adicionar</button>
                <dialog class="login-box" id="user_register_modal">
                    <div class="box-titulo">
                        <span class="titulo-modal">ADICIONAR Usuário</span>
                        <button class="botao-fechar-modal" onclick="user_register_modal.close()"><img width="24"
                                height="24" src="https://img.icons8.com/material-outlined/24/delete-sign.png"
                                alt="delete-sign"
                        />
                    </div>
                    <form action="#" class="login-form">
                        <div class="login-form-fields">
                            <div class="login-form-column">
                                <div class="login-form-field">
                                    <label for="nome">Nome</label>
                                    <input type="text" id="nome_func" name="nome">
                                </div>
            
                                <div class="login-form-field">
                                    <label for="funcao">Função</label>
                                    <input type="text" id="funcao_func" name="funcao">
                                </div>
            
                                <div class="login-form-field">
                                    <label for="senha">Senha</label>
                                    <input type="password" id="senha_func" name="senha">
                                </div>
                            </div>
            
                            <div class="login-form-column">
                                <div class="login-form-field">
                                    <label for="email">Email</label>
                                    <input type="text" id="email_func" name="email">
                                </div>
            
                                <div class="login-form-field">
                                    <label for="cpf">CPF</label>
                                    <input type="text" id="cpf_func" name="cpf">
                                </div>
            
                                <div class="login-form-field">
                                    <label for="confirmar-senha">Confirmar senha</label>
                                    <input type="password" id="confirmar-senha" name="confirmar-senha">
                                </div>
                            </div>
                        </div>
                        
                        <div class="button" onclick="cadastrar()">Cadastrar</div>
                    </form>
                </dialog>
            </div>
        </div>

        <div>
            <table id="lista_usuarios">
                <tr>
                    <th>Nome</th>
                    <th>Email</th>
                    <th>Função</th>
                    <th>Ações</th>
                  </tr>
                  <tr>
                    <td>${resposta[i].nomeCompleto}</td>
                    <td>${resposta[i].email}</td>
                    <td>${resposta[i].funcao}</td>
                    <td><button onclick="deletarUsuario(${resposta[i].idUsuario})">Excluir</button> <button onclick="editarUsuario(${resposta[i].idUsuario})">Editar</button></td>
                </tr>
                <tr>
                    <td>${resposta[i].nomeCompleto}</td>
                    <td>${resposta[i].email}</td>
                    <td>${resposta[i].funcao}</td>
                    <td><button onclick="deletarUsuario(${resposta[i].idUsuario})">Excluir</button> <button onclick="editarUsuario(${resposta[i].idUsuario})">Editar</button></td>
                </tr>
                <tr>
                    <td>${resposta[i].nomeCompleto}</td>
                    <td>${resposta[i].email}</td>
                    <td>${resposta[i].funcao}</td>
                    <td><button onclick="deletarUsuario(${resposta[i].idUsuario})">Excluir</button> <button onclick="editarUsuario(${resposta[i].idUsuario})">Editar</button></td>
                </tr>
            </table>
        </div>
    </main>
</body>
</html>

<script src="../../middlewares/aside-menu.js"></script>
<script>
        function cadastrar() {
        let nomeEmpresaVar = document.getElementById('nome_empresa').value;
        let cnpjEmpresaVar = document.getElementById('cnpj_empresa').value;
        let telefoneEmpresaVar = document.getElementById('telefone_empresa').value;

        let nomeFuncVar = document.getElementById('nome_func').value;
        let funcaoFuncVar = document.getElementById('funcao_func').value;
        let cpfFuncVar = document.getElementById('cpf_func').value;
        let emailFuncVar = document.getElementById('email_func').value;
        let senhaFuncVar = document.getElementById('senha_func').value;

        fetch("/usuarios/cadastrar", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                nomeEmpresaServer: nomeEmpresaVar,
                cnpjEmpresaServer: cnpjEmpresaVar,
                telefoneEmpresaServer: telefoneEmpresaVar,
                nomeFuncServer: nomeFuncVar,
                funcaoFuncServer: funcaoFuncVar,
                cpfFuncServer: cpfFuncVar,
                emailFuncServer: emailFuncVar,
                senhaFuncServer: senhaFuncVar
            }),
        })
        .then(function (resposta) {
            console.log("resposta: ", resposta);

            if (resposta.ok) {
                console.log("Cadastro realizado com sucesso! Redirecionando para tela de Login...");

                setTimeout(() => {
                    window.location = "./login.html";
                }, "2000");
            } else {
                throw "Houve um erro ao tentar realizar o cadastro!";
            }
        })
        .catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });
    }

    function mostrarUsuarios(idEmpresa) {
        fetch(`/usuarios/listarPorEmpresa/${idEmpresa}`).then(function (resposta) {
            let listaUsuarios = document.getElementById("lista_usuarios");
            if (resposta.ok) {
                if (resposta.status == 204) {
                    alert.innerHTML = "Nenhum resultado encontrado."
                    throw "Nenhum resultado encontrado!!";
                }

                resposta.json().then(function (resposta) {
                    console.log("Dados recebidos: ", JSON.stringify(resposta));

                    for (let i = 0; i < resposta.length; i++) {
                        listaUsuarios.innerHTML += `
                        <tr>
                            <td>${resposta[i].nomeCompleto}</td>
                            <td>${resposta[i].email}</td>
                            <td>${resposta[i].funcao}</td>
                            <td>${resposta[i].nome}</td>
                            <td><button onclick="deletarUsuario(${resposta[i].idUsuario})">Excluir</button> <button onclick="editarUsuario(${resposta[i].idUsuario})">Editar</button></td>
                        </tr>`
                    }
                });
            } else {
                throw ('Houve um erro na API!');
            }
        }).catch(function (resposta) {
            console.error(resposta);
        });
    }

    mostrarUsuarios(1);

    function deletarUsuario(idUsuario) {
        console.log("Criar função de apagar post escolhido - ID" + idUsuario);
        fetch(`/usuarios/deletarUsuario/${idUsuario}`, {
            method: "DELETE",
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (resposta) {

            if (resposta.ok) {
                window.alert("Usuário deletado com sucesso!");
                window.location = "/dashboard/admin.html"
            } else if (resposta.status == 404) {
                window.alert("Deu 404!");
            } else {
                throw ("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });
    }

    function editarUsuario(idUsuario) {
        sessionStorage.ID_USUARIO_EDITANDO = idUsuario;
        window.location = "/dashboard/edicao-usuario.html"
    }

    function mudar() {
    if (document.getElementById('primeiro-cadastro').style.display === 'block') {
        document.getElementById('primeiro-cadastro').style.display = 'none';
        document.getElementById('segundo-cadastro').style.display = 'block';
    } else {
        document.getElementById('primeiro-cadastro').style.display = 'block';
        document.getElementById('segundo-cadastro').style.display = 'none';
    }
}
</script>